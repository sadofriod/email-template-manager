# å®æ—¶ HTML é¢„è§ˆåŠŸèƒ½ - å®ç°æ€»ç»“

## âœ… å®Œæˆçš„åŠŸèƒ½

### 1. Web Component å®ç°
åˆ›å»ºäº†ä½¿ç”¨ Shadow DOM çš„è‡ªå®šä¹‰ Web Componentï¼š
- **æ–‡ä»¶**: `src/components/layout/preview/EmailPreviewComponent.ts`
- **åŠŸèƒ½**: 
  - ä½¿ç”¨ Shadow DOM å®ç° CSS å®Œå…¨éš”ç¦»
  - HTML å†…å®¹å®‰å…¨æ¸²æŸ“ï¼ˆç§»é™¤è„šæœ¬ã€äº‹ä»¶å¤„ç†å™¨ç­‰ï¼‰
  - é»˜è®¤é‚®ä»¶æ ·å¼ï¼ˆå­—ä½“ã€é“¾æ¥ã€è¡¨æ ¼ç­‰ï¼‰
  - ç©ºçŠ¶æ€å‹å¥½æç¤º

### 2. React é¢„è§ˆé¢æ¿ç»„ä»¶
åˆ›å»ºäº† LivePreviewPanel ç»„ä»¶é›†æˆ Web Componentï¼š
- **æ–‡ä»¶**: `src/components/layout/preview/LivePreviewPanel.tsx`
- **åŠŸèƒ½**:
  - ä½¿ç”¨ `createElement` æ¸²æŸ“è‡ªå®šä¹‰å…ƒç´ 
  - æ™ºèƒ½å˜é‡æ›¿æ¢ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
  - æœªå®šä¹‰å˜é‡é«˜äº®æ˜¾ç¤ºï¼ˆé»„è‰²èƒŒæ™¯ï¼‰
  - æ˜¾ç¤ºé‚®ä»¶ä¸»é¢˜
  - åº•éƒ¨æ˜¾ç¤ºå˜é‡åˆ—è¡¨
  - å®Œæ•´çš„å›½é™…åŒ–æ”¯æŒ

### 3. åˆ†å±å¸ƒå±€
æ›´æ–°äº†ä¸»å†…å®¹åŒºåŸŸä¸ºåˆ†å±å¸ƒå±€ï¼š
- **æ–‡ä»¶**: `src/components/layout/MainContent.tsx`
- **å¸ƒå±€**:
  - å·¦ä¾§ï¼šç¼–è¾‘å™¨ï¼ˆflex: 1ï¼‰
  - å³ä¾§ï¼šå®æ—¶é¢„è§ˆï¼ˆ40% å®½åº¦ï¼Œ400-600px èŒƒå›´ï¼‰
  - åªåœ¨ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºé¢„è§ˆ

### 4. å®æ—¶æ•°æ®æµ
å®ç°äº†ç¼–è¾‘å†…å®¹åˆ°é¢„è§ˆçš„å®æ—¶æ•°æ®æµï¼š
- **æ¨¡æ¿ç¼–è¾‘å™¨** (`TemplateEditor.tsx`):
  - æ·»åŠ  `onContentChange` å›è°ƒ
  - ä½¿ç”¨ `useEffect` ç›‘å¬è¡¨å•å˜åŒ–
  - å®æ—¶æ„å»ºå¹¶ä¼ é€’æ¨¡æ¿æ•°æ®

- **å¸ƒå±€ç®¡ç†å™¨** (`EmailTemplateLayout.tsx`):
  - ç®¡ç† `currentEditingData` çŠ¶æ€
  - å¤„ç†å†…å®¹å˜åŒ–å¹¶æ›´æ–°é¢„è§ˆ

### 5. ç±»å‹æ”¯æŒ
æ·»åŠ äº† Web Components çš„ TypeScript ç±»å‹å£°æ˜ï¼š
- **æ–‡ä»¶**: `src/types/web-components.d.ts`
- æ”¯æŒè‡ªå®šä¹‰å…ƒç´  `<email-preview>`

### 6. å›½é™…åŒ–
ä¸ºæ‰€æœ‰æ–°åŠŸèƒ½æ·»åŠ äº†å®Œæ•´çš„ç¿»è¯‘æ”¯æŒï¼š
- ä¸­æ–‡ (zh.json)
- è‹±æ–‡ (en.json)  
- æ—¥æ–‡ (ja.json)

ç¿»è¯‘é”®ï¼š
- `preview.livePreview` - å®æ—¶é¢„è§ˆ
- `preview.realtime` - å®æ—¶æ ‡ç­¾
- `preview.variablesUsed` - ä½¿ç”¨çš„å˜é‡
- `preview.noContent` - ç©ºçŠ¶æ€æç¤º

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶ (5)
1. `src/components/layout/preview/EmailPreviewComponent.ts` - Web Component
2. `src/components/layout/preview/LivePreviewPanel.tsx` - React é¢„è§ˆé¢æ¿
3. `src/components/layout/preview/index.ts` - å¯¼å‡ºæ–‡ä»¶
4. `src/types/web-components.d.ts` - ç±»å‹å£°æ˜
5. `LIVE_PREVIEW_FEATURE.md` - åŠŸèƒ½æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶ (7)
1. `src/components/layout/MainContent.tsx` - åˆ†å±å¸ƒå±€
2. `src/components/layout/EmailTemplateLayout.tsx` - æ•°æ®ç®¡ç†
3. `src/components/template/TemplateEditor.tsx` - å†…å®¹å˜åŒ–å›è°ƒ
4. `src/i18n/locales/zh.json` - ä¸­æ–‡ç¿»è¯‘
5. `src/i18n/locales/en.json` - è‹±æ–‡ç¿»è¯‘
6. `src/i18n/locales/ja.json` - æ—¥æ–‡ç¿»è¯‘
7. `DRAFT_AUTOSAVE_FEATURE.md` - ä¹‹å‰çš„è‰ç¨¿åŠŸèƒ½æ–‡æ¡£

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

### 1. Shadow DOM CSS éš”ç¦»
```typescript
// åˆ›å»º Shadow DOM
this.shadow = this.attachShadow({ mode: 'open' });

// å†…éƒ¨æ ·å¼å®Œå…¨éš”ç¦»
const style = document.createElement('style');
style.textContent = `
  :host {
    display: block;
    background: #ffffff;
  }
  // ... å…¶ä»–æ ·å¼
`;
```

### 2. å®‰å…¨çš„ HTML æ¸²æŸ“
```typescript
const dangerous = [
  /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
  /<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi,
  /on\w+\s*=\s*["'][^"']*["']/gi,
  /javascript:/gi,
];
```

### 3. æ™ºèƒ½å˜é‡æ›¿æ¢
```typescript
// å·²å®šä¹‰å˜é‡ï¼šä½¿ç”¨é»˜è®¤å€¼
variables.forEach((variable) => {
  const pattern = new RegExp(`{{\\s*${variable.name}\\s*}}`, "g");
  rendered = rendered.replace(pattern, variable.defaultValue || `[${variable.name}]`);
});

// æœªå®šä¹‰å˜é‡ï¼šé«˜äº®æ˜¾ç¤º
rendered = rendered.replace(/{{(\w+)}}/g, (_match, varName) => {
  return `<span style="background: #ffeb3b;">[${varName}]</span>`;
});
```

### 4. React ä¸­ä½¿ç”¨è‡ªå®šä¹‰å…ƒç´ 
```typescript
// ä½¿ç”¨ createElement é¿å… JSX ç±»å‹é—®é¢˜
{createElement("email-preview", { ref: previewRef })}
```

## ğŸ¨ ç”¨æˆ·ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‚®ä»¶æ¨¡æ¿ç¼–è¾‘å™¨                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   è¡¨å•ç¼–è¾‘åŒºåŸŸ              â”‚  â”‚  ğŸ“§ å®æ—¶é¢„è§ˆ [å®æ—¶]  â”‚  â”‚
â”‚                            â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚ ä¸»é¢˜: æ¬¢è¿é‚®ä»¶       â”‚  â”‚
â”‚   â”‚ æ¨¡æ¿ID          â”‚      â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚   â”‚ æ¨¡æ¿åç§°        â”‚      â”‚  â”‚                      â”‚  â”‚
â”‚   â”‚ ç±»å‹ã€å…¥å£      â”‚      â”‚  â”‚   æ¸²æŸ“çš„ HTML å†…å®¹    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚                      â”‚  â”‚
â”‚                            â”‚  â”‚   (ä½¿ç”¨ Shadow DOM)   â”‚  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚                      â”‚  â”‚
â”‚   â”‚ HTML å†…å®¹       â”‚  â”€â”€â–¶ â”‚  â”‚   å®æ—¶æ›´æ–°æ˜¾ç¤º        â”‚  â”‚
â”‚   â”‚                 â”‚      â”‚  â”‚                      â”‚  â”‚
â”‚   â”‚ {{title}}       â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   â”‚ {{content}}     â”‚      â”‚  ä½¿ç”¨çš„å˜é‡:              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  [title] [content]        â”‚  â”‚
â”‚                            â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµç¨‹

```
ç”¨æˆ·è¾“å…¥
   â†“
TemplateEditor (useEffect ç›‘å¬å˜åŒ–)
   â†“
onContentChange å›è°ƒ
   â†“
EmailTemplateLayout (æ›´æ–° currentEditingData)
   â†“
MainContent (ä¼ é€’ç»™ LivePreviewPanel)
   â†“
LivePreviewPanel (å˜é‡æ›¿æ¢)
   â†“
EmailPreviewComponent (Shadow DOM æ¸²æŸ“)
   â†“
å®æ—¶æ˜¾ç¤º
```

## âœ¨ å…³é”®ç‰¹æ€§

1. **å®Œå…¨ CSS éš”ç¦»**: Shadow DOM ç¡®ä¿é¢„è§ˆæ ·å¼ä¸å½±å“åº”ç”¨
2. **å®æ—¶æ›´æ–°**: ç¼–è¾‘å³å¯è§ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°
3. **å˜é‡æ™ºèƒ½å¤„ç†**: è‡ªåŠ¨æ›¿æ¢å¹¶é«˜äº®æœªå®šä¹‰å˜é‡
4. **å®‰å…¨æ¸²æŸ“**: ç§»é™¤å±é™©çš„è„šæœ¬å’Œäº‹ä»¶
5. **å“åº”å¼å¸ƒå±€**: é¢„è§ˆé¢æ¿å®½åº¦å¯è°ƒï¼ˆ400-600pxï¼‰
6. **å›½é™…åŒ–å®Œæ•´**: æ”¯æŒä¸­è‹±æ—¥ä¸‰è¯­
7. **ç©ºçŠ¶æ€å‹å¥½**: æœªè¾“å…¥å†…å®¹æ—¶æ˜¾ç¤ºæç¤º

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¼–è¾‘ HTML
```html
<h1>{{title}}</h1>
<p>Hello {{userName}}, {{greeting}}</p>
```

### å˜é‡é…ç½®
- title: "æ¬¢è¿" (é»˜è®¤å€¼)
- userName: "ç”¨æˆ·" (é»˜è®¤å€¼)
- greeting: æœªå®šä¹‰

### é¢„è§ˆæ•ˆæœ
```html
<h1>æ¬¢è¿</h1>
<p>Hello ç”¨æˆ·, <span style="background: #ffeb3b;">[greeting]</span></p>
```

## ğŸš€ åç»­å¯ä¼˜åŒ–

1. **å®‰å…¨å¢å¼º**: é›†æˆ DOMPurify åº“
2. **å“åº”å¼é¢„è§ˆ**: æ”¯æŒç§»åŠ¨ç«¯ã€å¹³æ¿è§†å›¾
3. **å¯è°ƒæ•´å®½åº¦**: æ‹–æ‹½è°ƒæ•´é¢„è§ˆé¢æ¿å¤§å°
4. **æ·±è‰²æ¨¡å¼**: æ”¯æŒä¸»é¢˜åˆ‡æ¢
5. **å…¨å±é¢„è§ˆ**: ç‹¬ç«‹çª—å£æŸ¥çœ‹
6. **æ€§èƒ½ä¼˜åŒ–**: å¤§å†…å®¹è™šæ‹Ÿæ»šåŠ¨

## ğŸ“Š é¡¹ç›®çŠ¶æ€

âœ… **æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡**
âœ… **æ— ç¼–è¯‘é”™è¯¯**
âœ… **å®Œæ•´çš„å›½é™…åŒ–æ”¯æŒ**
âœ… **è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜**

åŠŸèƒ½å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼ğŸ‰
